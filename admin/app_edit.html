<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - App Edit</title>
    <link rel="stylesheet" href="../assets/style.css" />
  </head>
  <body>
    <main>
      <h1>アプリ設定</h1>
      <p class="muted">選択中のデモの設定を学習用に編集します。</p>
      <div class="notice toast" id="saveMessage" role="status" aria-live="polite" hidden></div>
      <form class="card form-grid" id="samlForm">
        <h2>SAML-like 設定</h2>
        <p class="muted">SPとIdPの照合に必要な値を定義します。</p>
        <label>
          Name
          <input type="text" name="name" required />
        </label>
        <label>
          SP Entity ID (Audience)
          <input type="text" name="spEntityId" required />
          <small class="muted">Audience検証で利用します。</small>
        </label>
        <details>
          <summary>詳細設定</summary>
          <div class="form-grid">
            <label>
              ACS URL (Recipient)
              <input type="text" name="acsUrl" required />
              <small class="muted">Recipient検証で利用します。</small>
            </label>
            <label>
              Shared Secret
              <input type="text" name="sharedSecret" required />
              <small class="muted">署名検証の共有鍵として使います。</small>
            </label>
          </div>
        </details>
        <ul class="muted">
          <li>SP Entity IDはAudienceチェックで使われます。</li>
          <li>ACS URLはRecipientチェックで使われます。</li>
          <li>Shared Secretは署名検証で一致確認されます。</li>
        </ul>
        <button class="button" type="button" id="samlSaveButton">SAML設定を保存</button>
      </form>
      <form class="card form-grid" id="oidcForm">
        <h2>OIDC-like 設定</h2>
        <p class="muted">OIDCフローの識別子と戻り先を管理します。</p>
        <label>
          Name
          <input type="text" name="name" required />
        </label>
        <label>
          Client ID
          <input type="text" name="clientId" required />
          <small class="muted">client_idとして照合されます。</small>
        </label>
        <details>
          <summary>詳細設定</summary>
          <div class="form-grid">
            <label>
              Redirect URI
              <input type="text" name="redirectUri" required />
              <small class="muted">callbackの一致確認に使います。</small>
            </label>
          </div>
        </details>
        <ul class="muted">
          <li>Client IDは認可要求の一致チェックで使われます。</li>
          <li>Redirect URIはcallbackの受信先チェックで使われます。</li>
        </ul>
        <button class="button" type="button" id="oidcSaveButton">OIDC設定を保存</button>
      </form>
      <div class="card preview-card" id="savePreview" hidden></div>
      <a class="button secondary" data-demo-path="admin/index.html" href="./index.html">戻る</a>
    </main>
    <script type="module">
      import { renderHeader, renderLearningNav, renderLearningPanel, snapshotStorage, applyDemoLinks } from '../shared/ui.js';
      import { getJson, setJson, ensureDemoSeed, appendLog, resolveDemoSelection } from '../shared/storage.js';
      import { randomId } from '../shared/crypto.js';

      const init = () => {
        const { demo, rawDemo } = resolveDemoSelection({ fallback: 'saml' });
        renderHeader({ activeRole: 'admin', basePath: '..', demo });
        const saveMessage = document.getElementById('saveMessage');
        const savePreview = document.getElementById('savePreview');
        let toastTimer = null;
        const setMessage = (text, variant = 'info') => {
          if (!saveMessage) {
            return;
          }
          if (toastTimer) {
            clearTimeout(toastTimer);
          }
          saveMessage.textContent = text;
          saveMessage.hidden = false;
          saveMessage.classList.remove('success', 'error');
          if (variant) {
            saveMessage.classList.add(variant);
          }
          saveMessage.setAttribute('role', variant === 'error' ? 'alert' : 'status');
          toastTimer = window.setTimeout(() => {
            saveMessage.hidden = true;
          }, 3000);
        };
        const clearMessage = () => {
          if (!saveMessage) {
            return;
          }
          if (toastTimer) {
            clearTimeout(toastTimer);
          }
          saveMessage.hidden = true;
          saveMessage.textContent = '';
          saveMessage.classList.remove('success', 'error');
          saveMessage.setAttribute('role', 'status');
        };
        const hasInvalidDemo = rawDemo && !demo;
        if (hasInvalidDemo) {
          setMessage('デモ指定が不正です。?demo=saml または ?demo=oidc を指定してください。', 'error');
          return;
        }
        if (!demo) {
          setMessage('デモが未選択です。?demo=saml または ?demo=oidc を指定してください。', 'error');
          return;
        }
        applyDemoLinks(demo, { basePath: '..' });
        ensureDemoSeed(demo);

      const apps = getJson(demo, 'apps');
      const storedSamlApp = Array.isArray(apps) ? apps.find((item) => item.mode === 'saml_like') : null;
      const storedOidcApp = Array.isArray(apps) ? apps.find((item) => item.mode === 'oidc_like') : null;
      const samlDefaults = {
        id: randomId('app_saml'),
        name: 'Sample SAML App',
        mode: 'saml_like',
        spEntityId: 'sp.sample',
        acsUrl: '../sp/acs_receive.html',
        sharedSecret: 'dev-secret-change-me'
      };
      const oidcDefaults = {
        id: randomId('app_oidc'),
        name: 'Sample OIDC App',
        mode: 'oidc_like',
        clientId: 'client_demo',
        redirectUri: '../sp/callback.html'
      };
      let samlApp = storedSamlApp ?? samlDefaults;
      let oidcApp = storedOidcApp ?? oidcDefaults;

      const samlForm = document.getElementById('samlForm');
      const samlFallbacks = storedSamlApp ? {} : samlDefaults;
      samlForm.name.value = samlApp.name ?? samlFallbacks.name ?? '';
      samlForm.spEntityId.value = samlApp.spEntityId ?? samlFallbacks.spEntityId ?? '';
      samlForm.acsUrl.value = samlApp.acsUrl ?? samlFallbacks.acsUrl ?? '';
      samlForm.sharedSecret.value = samlApp.sharedSecret ?? samlFallbacks.sharedSecret ?? '';

      const oidcForm = document.getElementById('oidcForm');
      const oidcFallbacks = storedOidcApp ? {} : oidcDefaults;
      oidcForm.name.value = oidcApp.name ?? oidcFallbacks.name ?? '';
      oidcForm.clientId.value = oidcApp.clientId ?? oidcFallbacks.clientId ?? '';
      oidcForm.redirectUri.value = oidcApp.redirectUri ?? oidcFallbacks.redirectUri ?? '';

      if (demo === 'saml') {
        oidcForm.style.display = 'none';
      } else {
        samlForm.style.display = 'none';
      }

      const upsertApp = (updated) => {
        setJson(demo, 'apps', [updated]);
      };

      const readSamlValues = () => ({
        name: samlForm.name.value,
        spEntityId: samlForm.spEntityId.value,
        acsUrl: samlForm.acsUrl.value,
        sharedSecret: samlForm.sharedSecret.value
      });
      const readOidcValues = () => ({
        name: oidcForm.name.value,
        clientId: oidcForm.clientId.value,
        redirectUri: oidcForm.redirectUri.value
      });
      const refreshSamlForm = (app) => {
        samlForm.name.value = app.name ?? '';
        samlForm.spEntityId.value = app.spEntityId ?? '';
        samlForm.acsUrl.value = app.acsUrl ?? '';
        samlForm.sharedSecret.value = app.sharedSecret ?? '';
      };
      const refreshOidcForm = (app) => {
        oidcForm.name.value = app.name ?? '';
        oidcForm.clientId.value = app.clientId ?? '';
        oidcForm.redirectUri.value = app.redirectUri ?? '';
      };
      const loadSavedApp = (mode) => {
        const savedApps = getJson(demo, 'apps');
        if (!Array.isArray(savedApps)) {
          return null;
        }
        return savedApps.find((item) => item.mode === mode) || null;
      };
      const renderPreview = (app, mode) => {
        if (!savePreview) {
          return;
        }
        if (!app) {
          savePreview.hidden = true;
          return;
        }
        savePreview.hidden = false;
        savePreview.innerHTML = mode === 'saml'
          ? `
            <h2>保存内容プレビュー (SAML-like)</h2>
            <table class="table">
              <tr><th>Name</th><td>${app.name || '-'}</td></tr>
              <tr><th>SP Entity ID</th><td>${app.spEntityId || '-'}</td></tr>
              <tr><th>ACS URL</th><td>${app.acsUrl || '-'}</td></tr>
              <tr><th>Shared Secret</th><td>${app.sharedSecret || '-'}</td></tr>
            </table>
          `
          : `
            <h2>保存内容プレビュー (OIDC-like)</h2>
            <table class="table">
              <tr><th>Name</th><td>${app.name || '-'}</td></tr>
              <tr><th>Client ID</th><td>${app.clientId || '-'}</td></tr>
              <tr><th>Redirect URI</th><td>${app.redirectUri || '-'}</td></tr>
            </table>
          `;
      };

      const handleSamlSave = () => {
        clearMessage();
        const values = readSamlValues();
        console.log('[app_edit] save clicked', { demo, values });
        if (!samlForm.reportValidity()) {
          setMessage('入力内容を確認してください。', 'error');
          return;
        }
        const updated = {
          ...samlApp,
          ...values
        };
        try {
          upsertApp(updated);
          appendLog(demo, { actor: 'admin', action: 'update', detail: `update app ${updated.name}` });
          const savedApp = loadSavedApp('saml_like');
          if (!savedApp) {
            throw new Error('保存したSAML設定が見つかりません');
          }
          samlApp = savedApp;
          refreshSamlForm(savedApp);
          renderPreview(savedApp, 'saml');
          setMessage(`SAML設定を保存しました。(demo=${demo})`, 'success');
        } catch (error) {
          console.error('[app_edit] failed to save', error);
          setMessage('保存に失敗しました。入力内容を確認してください。', 'error');
        }
      };

      const handleOidcSave = () => {
        clearMessage();
        const values = readOidcValues();
        console.log('[app_edit] save clicked', { demo, values });
        if (!oidcForm.reportValidity()) {
          setMessage('入力内容を確認してください。', 'error');
          return;
        }
        const updated = {
          ...oidcApp,
          ...values
        };
        try {
          upsertApp(updated);
          appendLog(demo, { actor: 'admin', action: 'update', detail: `update app ${updated.name}` });
          const savedApp = loadSavedApp('oidc_like');
          if (!savedApp) {
            throw new Error('保存したOIDC設定が見つかりません');
          }
          oidcApp = savedApp;
          refreshOidcForm(savedApp);
          renderPreview(savedApp, 'oidc');
          setMessage(`OIDC設定を保存しました。(demo=${demo})`, 'success');
        } catch (error) {
          console.error('[app_edit] failed to save', error);
          setMessage('保存に失敗しました。入力内容を確認してください。', 'error');
        }
      };

      samlForm.addEventListener('submit', (event) => {
        event.preventDefault();
        handleSamlSave();
      });
      oidcForm.addEventListener('submit', (event) => {
        event.preventDefault();
        handleOidcSave();
      });
      document.getElementById('samlSaveButton').addEventListener('click', handleSamlSave);
      document.getElementById('oidcSaveButton').addEventListener('click', handleOidcSave);

      const panel = renderLearningPanel({
        purpose: 'デモごとの設定値を管理するフォーム。',
        params: {},
        generated: demo === 'saml' ? { samlApp } : { oidcApp },
        validation: [],
        storageSnapshot: snapshotStorage(demo),
        logs: snapshotStorage(demo).eventLog
      });
      renderPreview(demo === 'saml' ? samlApp : oidcApp, demo);
      const learningNav = renderLearningNav({
        demo,
        currentStep: 'admin',
        nextUrl: demo === 'saml' ? 'sp/login_saml.html' : 'sp/login_oidc.html',
        nextLabel: 'ログイン開始へ',
        basePath: '..'
      });
      const formAnchor = demo === 'saml' ? samlForm : oidcForm;
      document.querySelector('main').insertBefore(learningNav, formAnchor);
      document.querySelector('main').appendChild(panel);
      };

      init();
    </script>
  </body>
</html>
