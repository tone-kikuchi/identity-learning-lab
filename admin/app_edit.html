<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - App Edit</title>
    <link rel="stylesheet" href="/assets/style.css" />
  </head>
  <body>
    <main>
      <h1>SAML-like アプリ設定</h1>
      <p class="muted">SAMLのAudience/Recipient相当を学習用に編集します。</p>
      <form class="card form-grid" id="appForm">
        <label>
          Name
          <input type="text" name="name" required />
        </label>
        <label>
          SP Entity ID (Audience)
          <input type="text" name="spEntityId" required />
          <small class="muted">SAMLのAudience相当</small>
        </label>
        <label>
          ACS URL (Recipient)
          <input type="text" name="acsUrl" required />
          <small class="muted">SAMLのRecipient相当</small>
        </label>
        <label>
          Shared Secret
          <input type="text" name="sharedSecret" required />
          <small class="muted">証明書代わりの共有鍵（学習用）</small>
        </label>
        <button class="button" type="submit">保存</button>
      </form>
      <a class="button secondary" href="/admin/">戻る</a>
    </main>
    <script type="module">
      import { renderHeader, renderStepBar, renderLearningPanel, snapshotStorage } from '/shared/ui.js';
      import { getJson, setJson, resetAll, appendLog } from '/shared/storage.js';

      renderHeader('admin');
      if (!getJson('mockidp.apps')) {
        resetAll();
      }

      const [app] = getJson('mockidp.apps', []);
      const form = document.getElementById('appForm');
      form.name.value = app?.name || '';
      form.spEntityId.value = app?.spEntityId || '';
      form.acsUrl.value = app?.acsUrl || '/sp/acs_receive.html';
      form.sharedSecret.value = app?.sharedSecret || 'dev-secret-change-me';

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const updated = {
          ...app,
          name: form.name.value,
          spEntityId: form.spEntityId.value,
          acsUrl: form.acsUrl.value,
          sharedSecret: form.sharedSecret.value
        };
        setJson('mockidp.apps', [updated]);
        appendLog({ actor: 'admin', action: 'update', detail: `update app ${updated.name}` });
        window.location.href = '/admin/';
      });

      const panel = renderLearningPanel({
        purpose: 'SAML-likeのAudience/Recipient/共有鍵を管理するフォーム。',
        params: {},
        generated: { app },
        validation: [],
        storageSnapshot: snapshotStorage(),
        logs: snapshotStorage().eventLog
      });
      const stepBar = renderStepBar('saml', 0);
      document.querySelector('main').insertBefore(stepBar, form);
      document.querySelector('main').appendChild(panel);
    </script>
  </body>
</html>
