<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IdP Login</title>
    <link rel="stylesheet" href="../assets/style.css" />
  </head>
  <body>
    <main>
      <h1>IdP ログイン</h1>
      <p class="muted">IdP側でユーザー認証（学習用に選択式）を行います。</p>
      <form class="card form-grid" id="loginForm">
        <label>
          ユーザー選択
          <select name="userId" required></select>
        </label>
        <button class="button" type="submit">ログイン</button>
      </form>
      <div class="notice" id="inactiveNotice" hidden>選択したユーザーはinactiveです。</div>
    </main>
    <script type="module">
      import { renderHeader, renderLearningNav, renderLearningPanel, snapshotStorage, requireDemo, buildUrl } from '../shared/ui.js?v=1';
      import { getJson, setJson, ensureDemoSeed, appendLog } from '../shared/storage.js';

      const init = () => {
        const demo = requireDemo({ basePath: '..' });
        renderHeader({ activeRole: 'idp', basePath: '..', demo });
        if (!demo) {
          return;
        }
        ensureDemoSeed(demo);

      const params = new URLSearchParams(window.location.search);
      const returnTo = params.get('returnTo') || buildUrl('idp/index.html', { basePath: '..', demo });
      const users = getJson(demo, 'users', []);
      const select = document.querySelector('select[name="userId"]');
      users.forEach((user) => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = `${user.displayName} (${user.username})${user.active ? '' : ' - inactive'}`;
        option.disabled = !user.active;
        select.appendChild(option);
      });

      const notice = document.getElementById('inactiveNotice');
      select.addEventListener('change', () => {
        const selected = users.find((user) => user.id === select.value);
        notice.hidden = !selected || selected.active;
      });

      document.getElementById('loginForm').addEventListener('submit', (event) => {
        event.preventDefault();
        setJson(demo, 'idpSession', select.value);
        appendLog(demo, { actor: 'idp', action: 'login', detail: `user=${select.value}` });
        window.location.href = returnTo;
      });

      const panel = renderLearningPanel({
        purpose: 'IdP側でユーザー認証を行う（学習用に選択式）。',
        params: { returnTo },
        generated: { selectedUserId: select.value },
        validation: [],
        storageSnapshot: snapshotStorage(demo),
        logs: snapshotStorage(demo).eventLog
      });
      const learningNav = renderLearningNav({
        demo,
        currentStep: 'idp',
        basePath: '..'
      });
      document.querySelector('main').insertBefore(learningNav, document.querySelector('main').children[2]);
      document.querySelector('main').appendChild(panel);
      };

      init();
    </script>
  </body>
</html>
