<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SP Protected App</title>
    <link rel="stylesheet" href="../assets/style.css" />
  </head>
  <body>
    <main>
      <h1>保護ページ</h1>
      <p class="muted">ログイン済みのユーザーのみ表示されるページです。</p>
      <div class="card" id="sessionCard"></div>
      <div class="stack">
        <button class="button danger" id="logoutButton">ログアウト</button>
        <a class="button secondary" data-demo-path="sp/index.html" href="./index.html">SPホームへ戻る</a>
      </div>
      <div class="card" id="flowSummary"></div>
    </main>
    <script type="module">
      import { renderHeader, renderStepBar, renderLearningPanel, snapshotStorage, requireDemo, applyDemoLinks, buildUrl } from '../shared/ui.js';
      import { getJson, setJson, ensureDemoSeed, appendLog } from '../shared/storage.js';

      const demo = requireDemo({ basePath: '..' });
      renderHeader({ activeRole: 'sp', basePath: '..', demo });
      if (!demo) {
        return;
      }
      applyDemoLinks(demo, { basePath: '..' });
      ensureDemoSeed(demo);

      const params = new URLSearchParams(window.location.search);
      const appId = params.get('appId');
      const [app] = getJson(demo, 'apps', []).filter((item) => item.id === appId);
      const sessions = getJson(demo, 'spSessions', {});
      const session = app ? sessions[app.id] : null;

      if (!session) {
        window.location.href = buildUrl('sp/index.html', { basePath: '..', demo });
      }

      document.getElementById('sessionCard').innerHTML = `
        <h2>セッション情報</h2>
        <pre>${JSON.stringify(session, null, 2)}</pre>
      `;

      document.getElementById('logoutButton').addEventListener('click', () => {
        if (!app) {
          return;
        }
        const next = { ...sessions };
        delete next[app.id];
        setJson(demo, 'spSessions', next);
        appendLog(demo, { actor: 'sp', action: 'logout', detail: `app=${app.id}` });
        window.location.href = buildUrl('sp/index.html', { basePath: '..', demo });
      });

      const summary = document.getElementById('flowSummary');
      if (app?.mode === 'oidc_like') {
        summary.innerHTML = `
          <h2>今回のフローまとめ (OIDC-like)</h2>
          <ol>
            <li>SPがログイン開始</li>
            <li>IdPでユーザー認証</li>
            <li>IdPが認可コードを発行</li>
            <li>SPがcallbackで検証</li>
            <li>SPセッション作成</li>
          </ol>
        `;
      } else {
        summary.innerHTML = `
          <h2>今回のフローまとめ (SAML-like)</h2>
          <ol>
            <li>SPがログイン開始</li>
            <li>IdPでユーザー認証</li>
            <li>IdPがアサーションを生成</li>
            <li>SPのACSで検証</li>
            <li>SPセッション作成</li>
          </ol>
        `;
      }

      const panel = renderLearningPanel({
        purpose: 'ログイン成功後のみ表示される保護ページ。',
        params: { appId },
        generated: { session },
        validation: [],
        storageSnapshot: snapshotStorage(demo),
        logs: snapshotStorage(demo).eventLog
      });
      const stepBar = renderStepBar(app?.mode === 'oidc_like' ? 'oidc' : 'saml', 5);
      document.querySelector('main').insertBefore(stepBar, document.querySelector('main').children[2]);
      document.querySelector('main').appendChild(panel);
    </script>
  </body>
</html>
