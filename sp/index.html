<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SP Home</title>
    <link rel="stylesheet" href="../assets/style.css" />
  </head>
  <body>
    <main>
      <h1>SP Home</h1>
      <p class="muted">SPとしてログイン開始/セッション確認を行います。</p>
      <div class="card" id="sessionCard"></div>
      <div class="card stack" id="appCard"></div>
      <div class="stack" id="actionStack"></div>
    </main>
    <script type="module">
      import { renderHeader, renderStepBar, renderLearningPanel, snapshotStorage, requireDemo, buildUrl } from '../shared/ui.js';
      import { getJson, setJson, ensureDemoSeed, appendLog } from '../shared/storage.js';

      const demo = requireDemo({ basePath: '..' });
      renderHeader({ activeRole: 'sp', basePath: '..', demo });
      if (!demo) {
        return;
      }
      ensureDemoSeed(demo);

      const apps = getJson(demo, 'apps', []);
      const samlApp = apps.find((item) => item.mode === 'saml_like');
      const oidcApp = apps.find((item) => item.mode === 'oidc_like');
      const sessions = getJson(demo, 'spSessions', {});
      const samlSession = samlApp ? sessions[samlApp.id] : null;
      const oidcSession = oidcApp ? sessions[oidcApp.id] : null;

      const sessionCard = document.getElementById('sessionCard');
      sessionCard.innerHTML = demo === 'saml'
        ? `
          <h2>現在のSAML-likeセッション</h2>
          <pre>${JSON.stringify(samlSession || null, null, 2)}</pre>
        `
        : `
          <h2>現在のOIDC-likeセッション</h2>
          <pre>${JSON.stringify(oidcSession || null, null, 2)}</pre>
        `;

      const appCard = document.getElementById('appCard');
      appCard.innerHTML = demo === 'saml'
        ? `
          <h2>SAML-like アプリ</h2>
          <div>
            <p><strong>${samlApp?.name || '未設定'}</strong></p>
            <p class="muted">SP Entity ID: ${samlApp?.spEntityId || '-'}</p>
          </div>
        `
        : `
          <h2>OIDC-like アプリ</h2>
          <div>
            <p><strong>${oidcApp?.name || '未設定'}</strong></p>
            <p class="muted">Client ID: ${oidcApp?.clientId || '-'}</p>
          </div>
        `;

      const actionStack = document.getElementById('actionStack');
      if (demo === 'saml') {
        actionStack.innerHTML = `
          <a class="button" href="${buildUrl(`sp/login_saml.html?appId=${samlApp?.id || ''}`, { basePath: '..', demo })}">SAMLでログイン</a>
          <button class="button danger" id="logoutSaml">SAMLをログアウト</button>
        `;
      } else {
        actionStack.innerHTML = `
          <a class="button" href="${buildUrl(`sp/login_oidc.html?appId=${oidcApp?.id || ''}`, { basePath: '..', demo })}">OIDCでログイン</a>
          <button class="button danger" id="logoutOidc">OIDCをログアウト</button>
        `;
      }

      const logoutSaml = document.getElementById('logoutSaml');
      if (logoutSaml) {
        logoutSaml.addEventListener('click', () => {
          if (!samlApp) {
            return;
          }
          const next = { ...sessions };
          delete next[samlApp.id];
          setJson(demo, 'spSessions', next);
          appendLog(demo, { actor: 'sp', action: 'logout', detail: `app=${samlApp.id}` });
          window.location.reload();
        });
      }

      const logoutOidc = document.getElementById('logoutOidc');
      if (logoutOidc) {
        logoutOidc.addEventListener('click', () => {
          if (!oidcApp) {
            return;
          }
          const next = { ...sessions };
          delete next[oidcApp.id];
          setJson(demo, 'spSessions', next);
          appendLog(demo, { actor: 'sp', action: 'logout', detail: `app=${oidcApp.id}` });
          window.location.reload();
        });
      }

      const panel = renderLearningPanel({
        purpose: 'SP側でログイン開始やセッションの有無を確認する。',
        params: { samlAppId: samlApp?.id, oidcAppId: oidcApp?.id },
        generated: { samlSession, oidcSession },
        validation: [],
        storageSnapshot: snapshotStorage(demo),
        logs: snapshotStorage(demo).eventLog
      });
      const stepBar = renderStepBar(demo, 0);
      document.querySelector('main').insertBefore(stepBar, sessionCard);
      document.querySelector('main').appendChild(panel);
    </script>
  </body>
</html>
