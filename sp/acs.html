<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SP ACS Validation</title>
    <link rel="stylesheet" href="../assets/style.css" />
  </head>
  <body>
    <main>
      <h1>ACS 検証</h1>
      <p class="muted">IdPからのResponseを受け取り検証します。</p>
      <div class="card stack" id="inputCard"></div>
      <div class="card stack" id="payloadCard"></div>
      <div class="card stack" id="resultCard"></div>
    </main>
    <script type="module">
      import { renderHeader, renderStepBar, renderLearningPanel, snapshotStorage, requireDemo, buildUrl } from '../shared/ui.js';
      import { getJson, getSessionJson, setJson, ensureDemoSeed, appendLog } from '../shared/storage.js';
      import { verifySamlLikeResponse } from '../shared/protocol_saml_like.js';

      const demo = requireDemo({ basePath: '..' });
      renderHeader({ activeRole: 'sp', basePath: '..', demo });
      if (!demo) {
        return;
      }
      ensureDemoSeed(demo);

      const inputCard = document.getElementById('inputCard');
      const payloadCard = document.getElementById('payloadCard');
      const resultCard = document.getElementById('resultCard');

      const runValidation = async () => {
        const expected = getSessionJson(demo, 'expected', {});
        const received = getSessionJson(demo, 'received', {});
        const appId = expected.appId || received.appId;
        const [app] = getJson(demo, 'apps', []).filter((item) => item.id === appId);

        inputCard.innerHTML = `
          <h2>入力（POST body相当）</h2>
          <pre>${JSON.stringify(received, null, 2)}</pre>
        `;

        const expectedState = {
          requestId: expected.requestId,
          relayState: expected.relayState,
          receivedRelayState: received.RelayState
        };

        if (!app) {
          payloadCard.innerHTML = `
            <h2>decode結果（payload）</h2>
            <p class="notice">アプリ設定が見つかりません。Adminで設定を確認してください。</p>
          `;
          resultCard.innerHTML = `
            <h2>検証チェックリスト</h2>
            <p class="notice">アプリ設定がないため検証できません。</p>
            <a class="button secondary" href="${buildUrl('admin/index.html', { basePath: '..', demo })}">Adminへ戻る</a>
          `;
          appendLog(demo, { actor: 'sp', action: 'validation_failed', detail: 'app not found' });
          return;
        }

        const result = await verifySamlLikeResponse({
          app,
          expected: expectedState,
          b64: received.SAMLResponse
        });

        payloadCard.innerHTML = `
          <h2>decode結果（payload）</h2>
          <pre>${result.payload ? JSON.stringify(result.payload, null, 2) : '—'}</pre>
        `;

        resultCard.innerHTML = `
          <h2>検証チェックリスト</h2>
          <div>${result.checks
            .map((check) => {
              return `<div><span class="badge ${check.ok ? 'success' : 'fail'}">${check.ok ? 'OK' : 'NG'}</span> <strong>${check.name}</strong> <span class="muted">${check.detail || ''}</span></div>`;
            })
            .join('')}</div>
        `;

        if (result.ok && app && result.payload?.subject) {
          const sessions = getJson(demo, 'spSessions', {});
          sessions[app.id] = {
            ...result.payload.subject,
            loginAt: new Date().toISOString()
          };
          setJson(demo, 'spSessions', sessions);
          appendLog(demo, { actor: 'sp', action: 'session_created', detail: `user=${result.payload.subject.username}` });
          resultCard.innerHTML += `
            <p class="notice">検証成功。セッションを作成しました。</p>
            <a class="button" href="${buildUrl(`sp/app.html?appId=${app.id}`, { basePath: '..', demo })}">保護ページへ進む</a>
          `;
        } else {
          appendLog(demo, { actor: 'sp', action: 'validation_failed', detail: 'ACS validation failed' });
          resultCard.innerHTML += `
            <p class="notice">検証に失敗しました。戻ってやり直してください。</p>
            <a class="button secondary" href="${buildUrl(`sp/login_saml.html?appId=${appId || ''}`, { basePath: '..', demo })}">ログイン開始へ戻る</a>
          `;
        }

        const panel = renderLearningPanel({
          purpose: 'IdPから受け取ったSAMLResponseを検証し、OKならSPセッションを作成する。',
          params: { expected: expectedState, received },
          generated: result.payload,
          validation: result.checks,
          storageSnapshot: snapshotStorage(demo),
          logs: snapshotStorage(demo).eventLog
        });
        const stepBar = renderStepBar('saml', 4);
        document.querySelector('main').insertBefore(stepBar, inputCard);
        document.querySelector('main').appendChild(panel);
      };

      runValidation();
    </script>
  </body>
</html>
