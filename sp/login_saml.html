<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SP Login Start</title>
    <link rel="stylesheet" href="../assets/style.css" />
  </head>
  <body>
    <main>
      <h1>SP Login開始 (SAML-like)</h1>
      <p class="muted">SP initiated loginとしてIdPにリダイレクトします。</p>
      <div class="card stack">
        <h2>送信予定のパラメータ</h2>
        <pre id="requestPreview">Loading...</pre>
      </div>
      <div class="card stack">
        <label>
          <input type="checkbox" id="toggleRelay" /> RelayStateを壊す
        </label>
      </div>
      <button class="button" id="toIdpButton">IdPへ移動</button>
    </main>
    <script type="module">
      import { renderHeader, renderStepBar, renderLearningPanel, snapshotStorage, requireDemo, buildUrl } from '../shared/ui.js';
      import { getJson, getSessionJson, setSessionJson, ensureDemoSeed, appendLog } from '../shared/storage.js';
      import { randomId } from '../shared/crypto.js';

      const basePath = '..';
      const demo = requireDemo({ basePath });
      renderHeader({ activeRole: 'sp', basePath, demo });
      if (!demo) {
        return;
      }
      ensureDemoSeed(demo);

      const params = new URLSearchParams(window.location.search);
      const appId = params.get('appId') || getJson(demo, 'apps', [])[0]?.id;
      const [app] = getJson(demo, 'apps', []).filter((item) => item.id === appId);

      const requestId = randomId('req');
      const relayState = randomId('relay');
      const request = {
        appId: app?.id,
        acs: app?.acsUrl,
        spEntityId: app?.spEntityId,
        requestId,
        relayState
      };
      document.getElementById('requestPreview').textContent = JSON.stringify(request, null, 2);

      const toggleRelay = document.getElementById('toggleRelay');
      document.getElementById('toIdpButton').addEventListener('click', () => {
        const expectedRelay = relayState;
        const actualRelay = toggleRelay.checked ? `${relayState}_wrong` : relayState;
        setSessionJson(demo, 'expected', {
          appId: app?.id,
          requestId,
          relayState: expectedRelay
        });
        appendLog(demo, { actor: 'sp', action: 'login_start', detail: `requestId=${requestId}` });
        const idpUrl = new URL(buildUrl('idp/sso_saml.html', { basePath, demo }), window.location.href);
        idpUrl.searchParams.set('appId', app?.id || '');
        idpUrl.searchParams.set('acs', app?.acsUrl || '');
        idpUrl.searchParams.set('spEntityId', app?.spEntityId || '');
        idpUrl.searchParams.set('requestId', requestId);
        idpUrl.searchParams.set('relayState', actualRelay);
        window.location.href = idpUrl.toString();
      });

      const panel = renderLearningPanel({
        purpose: 'SP initiated loginとしてAuthnRequest相当のパラメータを作りIdPへリダイレクトする。',
        params: request,
        generated: { expectedStored: getSessionJson(demo, 'expected') || null },
        validation: [],
        storageSnapshot: snapshotStorage(demo),
        logs: snapshotStorage(demo).eventLog
      });
      const stepBar = renderStepBar('saml', 0);
      document.querySelector('main').insertBefore(stepBar, document.querySelector('main').children[2]);
      document.querySelector('main').appendChild(panel);
    </script>
  </body>
</html>
